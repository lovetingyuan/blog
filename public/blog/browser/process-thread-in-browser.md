[comment]: <browser> (title: '浏览器里的进程和线程', keywords: 'process, thread, browser', date: '2020-7-30')

## 浏览器里的进程和线程

现在的浏览器都是多进程的应用，通常来讲每开一个tab浏览器就会为其创建一个新的渲染进程。
一个完善的浏览器通常包括以下进程：
* 浏览器主进程，主要负责浏览器自身的UI，页面最终的呈现，tab页和窗口的管理，web资源（网络，文件，传感器）的管理等
* 渲染进程，上面提到过了
  * 如iframe，extension扩展等都会有自己的渲染进程
  * 从一个页面打开同一个根域名和协议的新tab，这时两个tab会共用一个渲染进程
* GPU进程，只有一个，负责独立于其他进程的GPU任务
* 插件进程，用来支持页面嵌入的插件，最常用的就是flash，嵌入式插件已经不推荐被使用了

这些进程本身都会包含多个线程来分担任务，除此之外，现代浏览器还会包含其他的辅助进程。

这些进程中与页面直接相关的就是渲染进程，浏览器进程会将下载好的代码交给渲染进程，它本身包含了多个线程：

* GUI线程，负责网页绘制
  * 解析html建立Dom树
  * 解析css并和dom树合并为渲染树
    * css的解析不会阻塞dom树构建但是会阻塞渲染，也会阻塞之后的JS执行
    * 渲染树只会包括可见的节点
  * 计算渲染树的布局信息，然后绘制具体的像素信息（启动GPU加速的图层会交由GPU进程单独处理）
    * 计算布局信息有时被称为回流，绘制被称为重绘，回流一定会引起重绘，它们都是昂贵的操作
    * 很多操作会让页面回流(reflow)，例如获取或更改元素或窗口位置或尺寸，用户或脚本引发的事件（聚焦，滚动，输入，选择），计算样式的值，元素的内容发生变化等等
  * 将计算得出的各个渲染层发送给GPU执行图层的合并和最终的绘制
* JS线程，负责执行JavaScript
  * 注意GUI线程和JS是互斥的（因为JS会操作DOM），同一时刻只能有一个执行
* 事件触发线程，负责任务队列的调度和轮询
* 定时器线程，处理`setTimeout`和`setInterval`，因为它们需要经过一段时间才能被放入任务队列
* http请求线程，每次发起请求都会有新的线程来负责此次的请求生命周期
* WebWorker线程，单独运行worker脚本（注意它与SharedWorker是不同的，后者是独立于所有页面的单独进程）

实际的运行中，以上各种线程和进程会互相通信，各取所取，最终完成页面的渲染和响应。
